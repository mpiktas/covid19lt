---
title: "COVID-19 situacijos 2020 ir 2021 metais palyginimas"
output: distill::distill_article
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(rmarkdown)
library(lubridate)
library(DT)
library(xts)
library(dygraphs)
library(zoo)
source("../R/functions.R")
```


```{r}
lv1 <- read.csv("../data/lt-covid19-country.csv") %>% mutate(day = ymd(day))

dd <- lv1 %>%
  select(day, confirmed_daily, hospitalized, icu, deaths_daily) %>%
  mutate(
    atvejai7 = rollmean(confirmed_daily, 7, align = "right", fill = NA),
    deaths7 = rollmean(deaths_daily, 7, align = "right", fill = NA)
  ) %>%
  mutate(
    atvejai = atvejai7 / max(atvejai7, na.rm = TRUE) * 100,
    hospitalizacijos = hospitalized / max(hospitalized, na.rm = TRUE) * 100,
    rits = icu / max(icu, na.rm = TRUE) * 100,
    mirtys = deaths7 / max(deaths7, na.rm = TRUE) * 100
  )

xdd <- xts(dd %>% select(atvejai, hospitalizacijos, rits, mirtys), dd$day)

last_day <- as.character(max(dd$day))
dw <- c("2020-10-01", last_day)
```

### Pagrindinių rodiklių palyginimas

Visi rodikliai normalizuoti maksimumu. 100 = maksimali reikšmė.

```{r}
dygraph(xdd) %>%
  dyOptions(colors = RColorBrewer::brewer.pal(4, "Set1")[c(3, 2, 4, 1)]) %>%
  dyRangeSelector(dateWindow = dw)
```

```{r}
tr <- read.csv("../data/osp/lt-covid19-transition.csv") %>% mutate(day = ymd(day))
init0 <- read.csv("../data/osp/lt-covid19-transition-init.csv")

tr11v <- add_states(tr %>% filter(age_gr %in% c("60-69", "70-79", "80+")), init0 %>% filter(age_gr %in% c("60-69", "70-79", "80+")), group = "age_gr")

tr20v <- tr11v %>%
  group_by(age_gr) %>%
  mutate(nevakcinuoti = bi0 / max(bi0, na.rm = TRUE) * 100)

tr21v <- tr20v %>%
  select(day, age_gr, nevakcinuoti) %>%
  pivot_wider(id_cols = day, names_from = "age_gr", values_from = "nevakcinuoti")


ii <- dd %>%
  select(day, rits) %>%
  left_join(tr21v)

xii <- xts(ii %>% select(-day), order.by = ii$day)
```

### Rits ir nevakcinuotų 60+ palyginimas

RITS ta pati laiko eilutė (neišskirta nei pagal amžių nei pagal vakcinacijos statusą). Nevakcinuoti 60+ tai 60+ amžiaus grupės asmenų neturėjusių skiepo ir teigiamo PGR/antigeno/antikūnų testo naujų atvejų skaičiai, 14 dienų vidurkiai normalizuoti pagal maksimalią atitinkamos laiko eilutės reikšmę.


```{r}
dygraph(xii) %>%
  dyOptions(colors = RColorBrewer::brewer.pal(4, "Set1")) %>%
  dyRangeSelector(dateWindow = dw)
```
