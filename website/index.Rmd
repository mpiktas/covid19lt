---
title: "COVID-19 Lietuvoje"

site: distill::distill_website
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(ggplot2)
library(readr)
library(tidyr)
library(dygraphs)
library(xts)
library(lubridate)
library(DT)
library(htmltools)
library(gridExtra)
```

```{r include=FALSE}
data <- Sys.time()
```
  - [Savivaldybių statistika](savivaldybes.html)    
  - [Europos šalių 14 dienų atvejai 100 tūkst. gyventojų](countries.html)
  - [Laboratorijų duomenys](stats.html)
  - [Ligoninių duomenys](hospital.html)
  - [Efektyvusis R](Re.html)
  
Atnaujinta: `r format(data, usetz = TRUE)`. 

```{r, echo = FALSE}
aa <- read.csv("../data/lt-covid19-country.csv", stringsAsFactors = FALSE) %>% mutate(day = ymd(day))
last_day <- max(aa$day)
fixNA <- function(x) {
    x[is.na(x)] <- 0
    x
}
aa_last_day <- as.character(max(aa$day))

view_interval <- c("2020-10-01", aa_last_day)

aa_stats <- aa %>% select(day,confirmed_growth_weekly, 
                          confirmed_100k, tpr_confirmed, tpr_tpn,
                          tpr_confirmed_diff_weekly, tpr_tpn_diff_weekly,
                          deaths_100k, other_deaths_100k, all_deaths_100k,
                          tests_100k, tests_mobile_100k,
                          tests_growth_weekly, tests_mobile_growth_weekly,
                          vaccinated_1_percent, vaccinated_2_percent
                         )

xaa <- xts(aa_stats %>% select(-day), aa_stats$day)

xi <- xts(aa %>% select(confirmed = confirmed_daily, deaths = deaths_daily, tests = tests_daily, mobile_tests = tests_mobile_daily, tpnew = tests_positive_new_daily, other_deaths = other_deaths_daily) %>% mutate(all_deaths = deaths+other_deaths), order.by = aa$day)


axtt14 <- rollmean(xi, 14, fill = NA, align = "right")
axtt7 <- rollmean(xi, 7, fill = NA, align = "right")
colnames(axtt7) <- paste0(colnames(axtt7),"7")
colnames(axtt14) <- paste0(colnames(axtt14),"14")
a714 <- cbind(xi, axtt7, axtt14)
    
```

```{r}

ltR <- dget("../raw_data/effectiveR/ltR.R")
ag <- function(x)(c(x[1],diff(x)))
dt <- aa %>% mutate(incidence = ag(confirmed)) %>% select(day, confirmed, incidence) %>% mutate(day = ymd(day), w = ifelse(incidence == 0, 0, 1))
dtf <- dt
dt <- dt %>% filter(day >= "2020-03-11") %>% mutate(times = 1:n())

oo <- ltR$R %>% inner_join(dt %>% rename(t_end=times), by ="t_end") %>% select(day, R = `Mean(R)`, lwr = `Quantile.0.025(R)`,upr = `Quantile.0.975(R)`)
bb <- xts(oo %>% select(-day), order.by=ymd(oo$day))
dygraph(bb, main = "Efektyvus reprodukcinis skaičius R") %>% dySeries(c("lwr","R","upr"), label = "R") %>% dyRangeSelector(dateWindow = view_interval) %>% dyLimit(1)

```

```{r}
dygraph(xaa[,"confirmed_growth_weekly"], main = paste("Savaitinis naujų atvejų augimas:",aa_last_day)) %>% dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[c(1)]) %>% dyRangeSelector(dateWindow = view_interval) %>% 
  dyLimit(0)
```

```{r, echo = FALSE}

dygraph(a714[, c("confirmed", "confirmed7","confirmed14")], main = paste("Nauji atvejai ir slenkantys vidurkiai:",max(aa$day))) %>% dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[c(3,1,2)]) %>% dyRangeSelector(dateWindow = view_interval)
```


```{r, echo = FALSE}

dygraph(a714["2020-03-20/",c("deaths","deaths7","deaths14")], main = paste("Mirtys per dieną ir slenkantys vidurkiai",max(aa$day))) %>%  dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[c(3,1,2)]) %>% dyRangeSelector(dateWindow = view_interval)
```


```{r, echo =FALSE}

ttn1 <- 100*a714[,"confirmed"]/a714[,"tests"]

ttn7 <- 100*a714[,"confirmed7"]/a714[,"tests7"]

ttn14 <- 100*a714[,"confirmed14"]/a714[,"tests14"]

ttn <- cbind(ttn1, ttn7, ttn14)
colnames(ttn) <- c("Atvejų proc.", "AP7", "AP14")

```


```{r, echo = FALSE}

tpntpr1 <- 100*a714[,"tpnew"]/a714[,"tests"]

tpntpr7 <- 100*a714[,"tpnew7"]/a714[,"tests7"]

tpntpr14 <- 100*a714[,"tpnew14"]/a714[,"tests14"]

tpntpr <- cbind(tpntpr1, tpntpr7, tpntpr14)
colnames(tpntpr) <- c("tpr", "tpr7", "tpr14")

dygraph(tpntpr["2020-04-01/"], main = paste("Teigiamų testų skaičius tenkantis 100 testų", max(aa$day))) %>% dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[c(3,1,2)]) %>% dyRangeSelector(dateWindow = view_interval) 
```

```{r}
dygraph(xaa[,"tests_100k"], main =  paste("Testų skaičius 100k gyventojų per 14 dienų ", aa_last_day)) %>%  dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[1]) %>% dyRangeSelector(dateWindow = view_interval) %>% dyLimit(0)
```

```{r}
dygraph(xaa["2020-12-27/",c("vaccinated_1_percent","vaccinated_2_percent")], main = paste("Paskiepytų pirma ir antra doze  procentas",aa_last_day)) %>% dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[c(1,3)]) %>% dyRangeSelector
```

```{r, echo = FALSE}
ii <- read.csv("../data/lt-covid19-individual.csv") %>% mutate(day = ymd(day))
ad <- read.csv("../data/lt-covid19-agedist.csv") %>% mutate(day = ymd(day))

ad_last_day <- max(ad$day)
ii_last_day <- max(ii$day)
ld_stats <- aa %>% filter(day == max(day))

p100k <- round(ld_stats$confirmed_100k[1],2)
pr <- round(ld_stats$tpr_confirmed[1],2)



```

### Atvejų amžiaus pasiskirstymas per pastarąsias 14 dienų, `r ad_last_day`

Lietuvoje 100k gyventojų per pastarąsias 14 dienų tenka **`r p100k`** atvejų. Testų pozityvumo norma ([test positivity rate](https://ec.europa.eu/info/live-work-travel-eu/health/coronavirus-response/travel-during-coronavirus-pandemic/common-approach-travel-measures-eu_en)) **`r pr`**.

```{r}
agr <- read.csv("../raw_data/agegroups.csv")
as_all <- expand_grid(age = unique(agr$age1), sex = c("Vyras","Moteris")) %>% mutate(n1 = 0)

oo <- ad%>% filter(day >= ad_last_day- days(13)) %>% inner_join(agr, by = "age") %>% select(-age) %>% rename(age=age1) %>% count(age, sex) %>% right_join(as_all, by = c("age", "sex")) %>% select(-n1) %>% mutate(n = fixNA(n)) %>% rename(Atvejai = n, Amžius = age) %>% pivot_wider(names_from = "sex", values_from = "Atvejai", values_fill = 0)

ld14 <- max(ad$day)-days(13)

cols<-RColorBrewer::brewer.pal(3, "Set1")

pm <- ggplot(aes(x=Amžius, y =Atvejai), data =oo %>% rename(Atvejai = Moteris)) + geom_col(fill = cols[1]) + geom_text(aes(label = Atvejai), hjust = 1.1) + coord_flip()+labs(y = "", x= "") + theme_bw() + scale_y_continuous(trans = "reverse", expand = expansion(mult=c(0.15, 0))) +  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), plot.margin = unit(c(0.02, 0.01, 0.02, 0.02),"npc")) + labs(title = "Moterys")

pv <- ggplot(aes(x=Amžius, y =Atvejai), data =oo %>% rename(Atvejai = Vyras)) + geom_col(fill = cols[2]) + geom_text(aes(label = Atvejai), hjust = -0.1)+coord_flip()+labs(y = "", x= "") + theme_bw() + scale_y_continuous( expand = expansion(mult=c(0, 0.18)))+theme(plot.margin = unit(c(0.02, 0.02, 0.02, -0.03),"npc"), plot.title = element_text(hjust = 1)) + labs(title = "Vyrai")

grid.arrange(pm,
    pv,
    ncol=2
)
```

### Istorinis mirčių pasiskirstymas pagal amžių, `r ii_last_day`

```{r}
last_day <- max(ii$day)


oo <- ii%>% filter(status == "Mirė") %>% inner_join(agr, by = "age") %>% select(-age) %>% rename(age=age1) %>% count(age, sex) %>% right_join(as_all, by = c("age", "sex")) %>% select(-n1) %>% mutate(n = fixNA(n))


oo <- oo %>% rename(Atvejai = n, Amžius = age) %>% pivot_wider(names_from = "sex", values_from = "Atvejai", values_fill = 0)


pm <- ggplot(aes(x=Amžius, y =Atvejai), data =oo %>% rename(Atvejai = Moteris)) + geom_col(fill = cols[1]) + geom_text(aes(label = Atvejai), hjust = 1.1) + coord_flip()+labs(y = "", x= "") + theme_bw() + scale_y_continuous(trans = "reverse", expand = expansion(mult=c(0.1, 0))) +  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank(), plot.margin = unit(c(0.02, 0.01, 0.02, 0.02),"npc")) + labs(title = "Moterys")

pv <- ggplot(aes(x=Amžius, y =Atvejai), data =oo %>% rename(Atvejai = Vyras)) + geom_col(fill = cols[2]) + geom_text(aes(label = Atvejai), hjust = -0.1)+coord_flip()+labs(y = "", x= "") + theme_bw() + scale_y_continuous( expand = expansion(mult=c(0, 0.12)))+theme(plot.margin = unit(c(0.02, 0.02, 0.02, -0.03),"npc"), plot.title = element_text(hjust = 1)) + labs(title = "Vyrai")

grid.arrange(pm,
    pv,
    ncol=2
)

```


```{r}

lv2 <- read.csv("../data/lt-covid19-level2.csv") %>% mutate(day = ymd(day))

ll <- lv2 %>% select(day, Apskritis = administrative_level_2, Atvejai = confirmed_100k, `Teigiamų tyrimų dalis` = tpr_confirmed, Mirtys = deaths_100k, Testai = tests_100k) %>% filter(Apskritis != "Unknown")

mll <- ll %>% pivot_longer(Atvejai:Testai, names_to = "type", values_to = "value")

```

## Mobilumo duomenys

```{r}
gm <- read.csv("../raw_data/google_mobility_lithuania/google_mobility_lithuania.csv") %>% mutate(day =ymd(day))
am <- read.csv("../data/lt-apple-mobility-data.csv") %>% mutate(day =ymd(day))
```

### Google `r max(gm$day)`

```{r}
xgm <- xts(gm %>% select(-day), gm$day)

dygraph(xgm, main = "Google mobilumo duomenys") %>% dyRangeSelector %>% dyOptions(colors = RColorBrewer::brewer.pal(6, "Paired"))
```


### Apple `r max(am$day)`

```{r}

xam<- xts(am %>% select(-day), am$day)

dygraph(xam, main = "Apple mobilumo duomenys") %>% dyRangeSelector %>% dyOptions(colors = RColorBrewer::brewer.pal(3, "Set1")[1:2])
```


## Situacija apskrityse `r aa_last_day`

```{r}
ggplot(aes(x = day, y = value, group =Apskritis, colour = Apskritis), data =mll %>% filter(day >= "2020-10-01"))+geom_line()+theme_bw()+scale_colour_manual(values= RColorBrewer::brewer.pal(10, "Paired"))+facet_wrap(~type, scales= "free_y")+labs(x="Data", y  = "")
```


## Atvejų pasiskirstymas pagal amžių ir savivaldybes `r ad_last_day` 

```{r}
agre <- read.csv("../data/lt-covid19-age-region-incidence.csv", check.names =  FALSE) 

agre1 <- agre %>% filter(day == max(day)) %>% select(-day) 

regs_n <- paste0(gsub("[.]","",gsub(" ", "_",agre1$administrative_level_3)),".html")

links <- paste0("regions/", regs_n) 

links2 <- mapply(function(nm, hr) tags$a(href=hr, nm),  agre1$administrative_level_3, links, SIMPLIFY = FALSE)


agre2 <- agre1
agre2$administrative_level_3 <- sapply(links2,as.character)
agre2$administrative_level_3[nrow(agre2)] <- "Total"

agre2 <- agre2 %>% rename(Savivaldybė = administrative_level_3)
agre2 %>% datatable( 
         extensions = c('FixedColumns',"FixedHeader"),
          escape = FALSE,
          options = list(scrollX = TRUE, 
                         paging=FALSE,
                         fixedHeader=TRUE))
```
